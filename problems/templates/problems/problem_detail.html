{% extends 'base.html' %}
{% load markdownx_tags %}
{% load static %}
{% load custom_filters %}
{% block title %}{{ problem.title }} | Exam Hub{% endblock %}

{% block content %}
  <h2>{{ problem.title }}</h2>
  
  <!-- å•é¡Œæ–‡ -->
  <div>
    <h4>å•é¡Œæ–‡</h4>
    <div class="markdown-content">
      {{ problem.body|markdownx }}
    </div>
  </div>

  <!-- è§£ç­” & è§£èª¬ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰-->
  <div>
    <h4>è§£ç­”ã¨è§£èª¬</h4>
    <button id="toggle-answer-btn" class="btn btn-outline-secondary my-3" onclick="toggleAnswerAndExplanation()">ç­”ãˆã‚’è¦‹ã‚‹</button>
    <div id="answer-section" style="display: none;">
      <div>
        <h4>è§£ç­”</h4>
        <div class="markdown-content">
          {{ problem.answer|markdownx }}
        </div>
      </div>
      {% if problem.explanation %}
        <div>
          <h4>è§£èª¬</h4>
          <div class="markdown-content">
            {{ problem.explanation|markdownx }}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å›ç­”è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ -->
  <button id="toggle-user-answers" class="btn btn-outline-secondary my-3">ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’è¦‹ã‚‹</button>
  <div id="user-answers-section" style="display: none;">
    <h4>ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å›ç­”</h4>
    {% for answer in problem.answers.all %}
      <div class="card my-4 shadow-sm border border-dark">
        <div class="card-body">
          <p><strong>{{ answer.author.username }}</strong> ã•ã‚“ã®å›ç­”ï¼š</p>
          <!-- å›ç­”ã®ç›®çš„ã‚’ã‚¿ã‚°ã¨ã—ã¦è¡¨ç¤º -->
          <div class="mb-2">
            {% for purpose in answer.purposes.all %}
              <span class="badge bg-secondary">{{ purpose.label }}</span>
            {% endfor %}
          </div>
          <div class="markdown-content">
            <h5>è§£ç­”</h5>
            {{ answer.answer_text|markdownx }}
            <h5>è§£èª¬</h5>
            {{ answer.explanation|markdownx }}
          </div>
          <p class="text-muted">æŠ•ç¨¿æ—¥æ™‚: {{ answer.created_at|date:"Yå¹´næœˆjæ—¥ H:i" }}</p>
        </div>
        <button
          class="reaction-button"
          data-answer-id="{{ answer.id }}"
          data-reaction-type="good"
        >
          ğŸ‘ {{ answer.good_count }}
        </button>

        <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
        <div class="mt-3 ms-3">
          <button class="btn btn-sm btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#comment-list-{{ answer.id }}">
            ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹
          </button>
          <div class="collapse" id="comment-list-{{ answer.id }}">
            <div class="border p-2 comment-list" style="max-height: 200px; overflow-y: auto;">
              {% for comment in answer.comments.all %}
                <div class="border-bottom pb-1 mb-1">
                  <strong>{{ comment.author.username }}</strong>: {{ comment.body }}
                  <span class="text-muted" style="font-size: 0.8em">({{ comment.created_at|date:"Y-m-d H:i" }})</span>
                </div>
              {% empty %}
                <p class="text-muted">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
              {% endfor %}
            </div>
          </div>
        </div>
        <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
        {% if user.is_authenticated %}
          {% with comment_forms|get_by_key:answer.id as form %}
            <form id="comment-form-{{ answer.id }}" class="comment-form" data-answer-id="{{ answer.id }}" method="post" action="{% url 'problems:post_comment' answer.id %}">
              {% csrf_token %}
              {{ form.as_p }}
              <button type="submit" class="btn btn-sm btn-outline-primary">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</button>
            </form>
          {% endwith %}
        {% else %}
          <p class="ms-3 text-muted">ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
        {% endif %}
      </div> <!-- /card -->
    {% empty %}
      <p>ã¾ã ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endfor %}
  </div> <!-- /user-answers-section -->
  <a href="{% url 'problems:submit_answer' problem.id %}" class="btn btn-primary">è‡ªåˆ†ã®å›ç­”ã‚’æŠ•ç¨¿ã™ã‚‹</a>

  <p><strong>é›£æ˜“åº¦:</strong> {{ problem.difficulty }}</p>
  
  {% if problem.category %}
    <p><strong>ã‚«ãƒ†ã‚´ãƒªãƒ¼:</strong> {{ problem.category.name }}</p>
  {% endif %}
  
  <p><strong>æŠ•ç¨¿è€…:</strong> <a href="{% url 'accounts:profile' problem.author.username %}">{{ problem.author.username }}</a></p>
  
  {% if request.user == problem.author %}
    <a href="{% url 'problems:edit' problem.id %}">ç·¨é›†</a>
    <a href="{% url 'problems:delete' problem.id %}">å‰Šé™¤</a>
  {% endif %}
  <a href="{% url 'problems:list' %}" class="btn btn-secondary">ä¸€è¦§ã«æˆ»ã‚‹</a>

  <!-- JavaScriptã§ç­”ãˆã¨è§£èª¬ã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã™ã‚‹ -->
  <script>
    function toggleAnswerAndExplanation() {
        let answerSection = document.getElementById("answer-section");
        let button = document.getElementById("toggle-answer-btn");

        if (answerSection.style.display === "none") {
            answerSection.style.display = "block";
            button.innerText = "ç­”ãˆã‚’éš ã™";
        } else {
            answerSection.style.display = "none";
            button.innerText = "ç­”ãˆã‚’è¦‹ã‚‹";
        }
    }
  </script>
  <!-- TypeScriptã§æ›¸ã„ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¾Œã®JSï¼‰ -->
  <script type="module" src="{% static 'js/reaction.js' %}"></script>
  <script>
    document.getElementById("toggle-user-answers").addEventListener("click", function() {
      const section = document.getElementById("user-answers-section");
      const btn = this;
      if (section.style.display === "none") {
        section.style.display = "block";
        btn.innerText = "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’éš ã™";
      } else {
        section.style.display = "none";
        btn.innerText = "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’è¦‹ã‚‹";
      }
    });
  </script>
  <script type="module" src="{% static 'js/comment.js' %}"></script>
{% endblock %}
